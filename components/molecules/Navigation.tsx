"use client";

import React, { useEffect, useState } from "react";
import Link from "next/link";
import { usePathname, useSearchParams } from "next/navigation";
import { cn } from "@/lib/utils";
import { Menu, CircleUser } from "lucide-react";
import { Button } from "@/components/ui/button";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";
import { Sheet, SheetContent, SheetTrigger } from "@/components/ui/sheet";
import supabaseClient from "@/lib/supabase/client";
import { User } from "@supabase/auth-js";
import { logout } from "@/lib/supabase/auth";

const navItems = [
  { href: "/home", label: "Facturas" },
  { href: "/home/products", label: "Productos" },
  { href: "/home/customers", label: "Clientes" },
  { href: "/home/settings", label: "Configuracion" },
];

const FacturaLogo = () => (
  <svg
    width="165"
    height="27"
    viewBox="0 0 165 27"
    fill="none"
    xmlns="http://www.w3.org/2000/svg"
  >
    <path
      d="M19.5 8L16.8848 5.586C16.4786 5.2109 15.9276 5.00011 15.353 5H6.50001C5.92537 5 5.37427 5.21071 4.96795 5.58579C4.56162 5.96086 4.33334 6.46957 4.33334 7V23C4.33334 23.5304 4.56162 24.0391 4.96795 24.4142C5.37427 24.7893 5.92537 25 6.50001 25H19.5C20.0746 25 20.6257 24.7893 21.0321 24.4142C21.4384 24.0391 21.6667 23.5304 21.6667 23"
      stroke="#00A1D4"
      strokeWidth="2"
      strokeLinecap="round"
      strokeLinejoin="round"
    />
    <path
      d="M23.1595 15.6259C23.591 15.2275 23.8335 14.6873 23.8335 14.1239C23.8335 13.5605 23.591 13.0203 23.1595 12.6219C22.7279 12.2235 22.1426 11.9998 21.5323 11.9998C20.922 11.9998 20.3367 12.2235 19.9052 12.6219L15.561 16.6339C15.3034 16.8715 15.1149 17.1652 15.0128 17.4879L14.1061 20.3579C14.0789 20.444 14.0773 20.5352 14.1014 20.622C14.1255 20.7088 14.1744 20.7881 14.2431 20.8515C14.3117 20.9148 14.3976 20.96 14.4916 20.9823C14.5857 21.0045 14.6845 21.003 14.7777 20.9779L17.8869 20.1409C18.2365 20.0467 18.5547 19.8727 18.8121 19.6349L23.1595 15.6259Z"
      stroke="#00A1D4"
      strokeWidth="2"
      strokeLinecap="round"
      strokeLinejoin="round"
    />
    <path
      d="M8.66666 21H9.74999"
      stroke="#00A1D4"
      strokeWidth="2"
      strokeLinecap="round"
      strokeLinejoin="round"
    />
    <path
      d="M39.84 6.76C40.2213 6.76 40.594 6.812 40.958 6.916C41.322 7.02 41.6253 7.19333 41.868 7.436C42.1107 7.66133 42.232 7.96467 42.232 8.346C42.232 8.77933 42.102 9.126 41.842 9.386C41.5993 9.62867 41.3133 9.75 40.984 9.75C40.828 9.75 40.594 9.71533 40.282 9.646C39.97 9.55933 39.6667 9.516 39.372 9.516C38.9387 9.516 38.6007 9.61133 38.358 9.802C38.1327 9.99267 37.9767 10.218 37.89 10.478C37.8033 10.7207 37.76 10.9373 37.76 11.128V24.414C37.76 24.8647 37.6127 25.246 37.318 25.558C37.0233 25.8527 36.6507 26 36.2 26C35.7493 26 35.3767 25.8527 35.082 25.558C34.7873 25.246 34.64 24.8647 34.64 24.414V11.154C34.64 9.92333 35.0733 8.88333 35.94 8.034C36.8067 7.18467 38.1067 6.76 39.84 6.76ZM40.126 12.35C40.542 12.35 40.8887 12.4887 41.166 12.766C41.4433 13.026 41.582 13.364 41.582 13.78C41.582 14.196 41.4433 14.5427 41.166 14.82C40.8887 15.08 40.542 15.21 40.126 15.21H33.236C32.82 15.21 32.4733 15.08 32.196 14.82C31.9187 14.5427 31.78 14.196 31.78 13.78C31.78 13.364 31.9187 13.026 32.196 12.766C32.4733 12.4887 32.82 12.35 33.236 12.35H40.126ZM55.4276 11.83C55.8783 11.83 56.2509 11.9773 56.5456 12.272C56.8403 12.5667 56.9876 12.948 56.9876 13.416V24.414C56.9876 24.8647 56.8403 25.246 56.5456 25.558C56.2509 25.8527 55.8783 26 55.4276 26C54.9769 26 54.6043 25.8527 54.3096 25.558C54.0149 25.246 53.8676 24.8647 53.8676 24.414V23.14L54.4396 23.374C54.4396 23.5993 54.3183 23.8767 54.0756 24.206C53.8329 24.518 53.5036 24.83 53.0876 25.142C52.6716 25.454 52.1776 25.7227 51.6056 25.948C51.0509 26.156 50.4443 26.26 49.7856 26.26C48.5896 26.26 47.5063 25.9567 46.5356 25.35C45.5649 24.726 44.7936 23.8767 44.2216 22.802C43.6669 21.71 43.3896 20.462 43.3896 19.058C43.3896 17.6367 43.6669 16.3887 44.2216 15.314C44.7936 14.222 45.5563 13.3727 46.5096 12.766C47.4629 12.142 48.5203 11.83 49.6816 11.83C50.4269 11.83 51.1116 11.9427 51.7356 12.168C52.3596 12.3933 52.8969 12.6793 53.3476 13.026C53.8156 13.3727 54.1709 13.728 54.4136 14.092C54.6736 14.4387 54.8036 14.7333 54.8036 14.976L53.8676 15.314V13.416C53.8676 12.9653 54.0149 12.5927 54.3096 12.298C54.6043 11.986 54.9769 11.83 55.4276 11.83ZM50.1756 23.4C50.9383 23.4 51.6056 23.2093 52.1776 22.828C52.7496 22.4467 53.1916 21.9267 53.5036 21.268C53.8329 20.6093 53.9976 19.8727 53.9976 19.058C53.9976 18.226 53.8329 17.4807 53.5036 16.822C53.1916 16.1633 52.7496 15.6433 52.1776 15.262C51.6056 14.8807 50.9383 14.69 50.1756 14.69C49.4303 14.69 48.7716 14.8807 48.1996 15.262C47.6276 15.6433 47.1769 16.1633 46.8476 16.822C46.5356 17.4807 46.3796 18.226 46.3796 19.058C46.3796 19.8727 46.5356 20.6093 46.8476 21.268C47.1769 21.9267 47.6276 22.4467 48.1996 22.828C48.7716 23.2093 49.4303 23.4 50.1756 23.4ZM66.5538 11.83C67.5418 11.83 68.3998 11.934 69.1278 12.142C69.8731 12.35 70.4451 12.6447 70.8438 13.026C71.2598 13.39 71.4678 13.832 71.4678 14.352C71.4678 14.6987 71.3638 15.028 71.1558 15.34C70.9478 15.6347 70.6444 15.782 70.2458 15.782C69.9684 15.782 69.7344 15.7473 69.5438 15.678C69.3704 15.5913 69.2144 15.4873 69.0758 15.366C68.9371 15.2447 68.7724 15.132 68.5818 15.028C68.4084 14.924 68.1398 14.846 67.7758 14.794C67.4291 14.7247 67.1691 14.69 66.9958 14.69C66.1118 14.69 65.3578 14.8807 64.7338 15.262C64.1271 15.6433 63.6591 16.1633 63.3298 16.822C63.0004 17.4633 62.8358 18.2087 62.8358 19.058C62.8358 19.89 63.0004 20.6353 63.3298 21.294C63.6764 21.9353 64.1444 22.4467 64.7338 22.828C65.3404 23.2093 66.0338 23.4 66.8138 23.4C67.2471 23.4 67.6198 23.374 67.9318 23.322C68.2438 23.27 68.5038 23.192 68.7118 23.088C68.9544 22.9493 69.1711 22.802 69.3618 22.646C69.5524 22.49 69.8384 22.412 70.2198 22.412C70.6704 22.412 71.0171 22.5593 71.2598 22.854C71.5024 23.1313 71.6238 23.478 71.6238 23.894C71.6238 24.3273 71.3811 24.726 70.8958 25.09C70.4104 25.4367 69.7691 25.7227 68.9718 25.948C68.1918 26.156 67.3424 26.26 66.4238 26.26C65.0544 26.26 63.8671 25.948 62.8618 25.324C61.8564 24.6827 61.0764 23.816 60.5218 22.724C59.9844 21.632 59.7158 20.41 59.7158 19.058C59.7158 17.6367 60.0018 16.3887 60.5738 15.314C61.1631 14.222 61.9691 13.3727 62.9918 12.766C64.0318 12.142 65.2191 11.83 66.5538 11.83ZM74.0296 12.35H80.1916C80.6076 12.35 80.9543 12.4887 81.2316 12.766C81.5089 13.0433 81.6476 13.39 81.6476 13.806C81.6476 14.2047 81.5089 14.5427 81.2316 14.82C80.9543 15.08 80.6076 15.21 80.1916 15.21H74.0296C73.6136 15.21 73.2669 15.0713 72.9896 14.794C72.7123 14.5167 72.5736 14.17 72.5736 13.754C72.5736 13.3553 72.7123 13.026 72.9896 12.766C73.2669 12.4887 73.6136 12.35 74.0296 12.35ZM76.8116 9.1C77.2623 9.1 77.6263 9.256 77.9036 9.568C78.1983 9.86267 78.3456 10.2353 78.3456 10.686V22.256C78.3456 22.4987 78.3889 22.698 78.4756 22.854C78.5796 23.01 78.7096 23.1227 78.8656 23.192C79.0389 23.2613 79.2209 23.296 79.4116 23.296C79.6196 23.296 79.8103 23.2613 79.9836 23.192C80.1569 23.1053 80.3563 23.062 80.5816 23.062C80.8243 23.062 81.0409 23.1747 81.2316 23.4C81.4396 23.6253 81.5436 23.9373 81.5436 24.336C81.5436 24.8213 81.2749 25.22 80.7376 25.532C80.2176 25.844 79.6543 26 79.0476 26C78.6836 26 78.2763 25.974 77.8256 25.922C77.3923 25.8527 76.9763 25.7053 76.5776 25.48C76.1963 25.2373 75.8756 24.8733 75.6156 24.388C75.3556 23.9027 75.2256 23.2353 75.2256 22.386V10.686C75.2256 10.2353 75.3729 9.86267 75.6676 9.568C75.9796 9.256 76.3609 9.1 76.8116 9.1ZM94.8343 12.09C95.2849 12.09 95.6576 12.246 95.9523 12.558C96.2469 12.8527 96.3943 13.2253 96.3943 13.676V20.28C96.3943 22.1173 95.8829 23.5733 94.8603 24.648C93.8376 25.7227 92.3643 26.26 90.4403 26.26C88.5163 26.26 87.0429 25.7227 86.0203 24.648C85.0149 23.5733 84.5123 22.1173 84.5123 20.28V13.676C84.5123 13.2253 84.6596 12.8527 84.9543 12.558C85.2489 12.246 85.6216 12.09 86.0723 12.09C86.5229 12.09 86.8956 12.246 87.1903 12.558C87.4849 12.8527 87.6323 13.2253 87.6323 13.676V20.28C87.6323 21.3373 87.8663 22.126 88.3343 22.646C88.8023 23.1487 89.5043 23.4 90.4403 23.4C91.3936 23.4 92.1043 23.1487 92.5723 22.646C93.0403 22.126 93.2743 21.3373 93.2743 20.28V13.676C93.2743 13.2253 93.4216 12.8527 93.7163 12.558C94.0109 12.246 94.3836 12.09 94.8343 12.09ZM101.332 26C100.881 26 100.509 25.8527 100.214 25.558C99.9194 25.246 99.772 24.8647 99.772 24.414V13.676C99.772 13.2253 99.9194 12.8527 100.214 12.558C100.509 12.246 100.881 12.09 101.332 12.09C101.783 12.09 102.155 12.246 102.45 12.558C102.745 12.8527 102.892 13.2253 102.892 13.676V16.12L102.71 14.378C102.901 13.962 103.143 13.598 103.438 13.286C103.75 12.9567 104.097 12.688 104.478 12.48C104.859 12.2547 105.267 12.09 105.7 11.986C106.133 11.882 106.567 11.83 107 11.83C107.52 11.83 107.953 11.9773 108.3 12.272C108.664 12.5667 108.846 12.9133 108.846 13.312C108.846 13.884 108.699 14.3 108.404 14.56C108.109 14.8027 107.789 14.924 107.442 14.924C107.113 14.924 106.809 14.8633 106.532 14.742C106.272 14.6207 105.969 14.56 105.622 14.56C105.31 14.56 104.989 14.638 104.66 14.794C104.348 14.9327 104.053 15.158 103.776 15.47C103.516 15.782 103.299 16.172 103.126 16.64C102.97 17.0907 102.892 17.628 102.892 18.252V24.414C102.892 24.8647 102.745 25.246 102.45 25.558C102.155 25.8527 101.783 26 101.332 26ZM122.129 11.83C122.579 11.83 122.952 11.9773 123.247 12.272C123.541 12.5667 123.689 12.948 123.689 13.416V24.414C123.689 24.8647 123.541 25.246 123.247 25.558C122.952 25.8527 122.579 26 122.129 26C121.678 26 121.305 25.8527 121.011 25.558C120.716 25.246 120.569 24.8647 120.569 24.414V23.14L121.141 23.374C121.141 23.5993 121.019 23.8767 120.777 24.206C120.534 24.518 120.205 24.83 119.789 25.142C119.373 25.454 118.879 25.7227 118.307 25.948C117.752 26.156 117.145 26.26 116.487 26.26C115.291 26.26 114.207 25.9567 113.237 25.35C112.266 24.726 111.495 23.8767 110.923 22.802C110.368 21.71 110.091 20.462 110.091 19.058C110.091 17.6367 110.368 16.3887 110.923 15.314C111.495 14.222 112.257 13.3727 113.211 12.766C114.164 12.142 115.221 11.83 116.383 11.83C117.128 11.83 117.813 11.9427 118.437 12.168C119.061 12.3933 119.598 12.6793 120.049 13.026C120.517 13.3727 120.872 13.728 121.115 14.092C121.375 14.4387 121.505 14.7333 121.505 14.976L120.569 15.314V13.416C120.569 12.9653 120.716 12.5927 121.011 12.298C121.305 11.986 121.678 11.83 122.129 11.83ZM116.877 23.4C117.639 23.4 118.307 23.2093 118.879 22.828C119.451 22.4467 119.893 21.9267 120.205 21.268C120.534 20.6093 120.699 19.8727 120.699 19.058C120.699 18.226 120.534 17.4807 120.205 16.822C119.893 16.1633 119.451 15.6433 118.879 15.262C118.307 14.8807 117.639 14.69 116.877 14.69C116.131 14.69 115.473 14.8807 114.901 15.262C114.329 15.6433 113.878 16.1633 113.549 16.822C113.237 17.4807 113.081 18.226 113.081 19.058C113.081 19.8727 113.237 20.6093 113.549 21.268C113.878 21.9267 114.329 22.4467 114.901 22.828C115.473 23.2093 116.131 23.4 116.877 23.4ZM128.445 25.974C127.942 25.974 127.552 25.844 127.275 25.584C127.015 25.3067 126.885 24.9167 126.885 24.414V23.972C126.885 23.4693 127.015 23.088 127.275 22.828C127.552 22.5507 127.942 22.412 128.445 22.412H128.783C129.286 22.412 129.667 22.5507 129.927 22.828C130.204 23.088 130.343 23.4693 130.343 23.972V24.414C130.343 24.9167 130.204 25.3067 129.927 25.584C129.667 25.844 129.286 25.974 128.783 25.974H128.445ZM140.848 11.83C142.096 11.83 143.04 12.0987 143.682 12.636C144.34 13.1733 144.791 13.8927 145.034 14.794C145.276 15.678 145.398 16.666 145.398 17.758V24.414C145.398 24.8647 145.25 25.246 144.956 25.558C144.661 25.8527 144.288 26 143.838 26C143.387 26 143.014 25.8527 142.72 25.558C142.425 25.246 142.278 24.8647 142.278 24.414V17.758C142.278 17.186 142.208 16.6747 142.07 16.224C141.931 15.756 141.68 15.3833 141.316 15.106C140.952 14.8287 140.432 14.69 139.756 14.69C139.097 14.69 138.534 14.8287 138.066 15.106C137.598 15.3833 137.242 15.756 137 16.224C136.774 16.6747 136.662 17.186 136.662 17.758V24.414C136.662 24.8647 136.514 25.246 136.22 25.558C135.925 25.8527 135.552 26 135.102 26C134.651 26 134.278 25.8527 133.984 25.558C133.689 25.246 133.542 24.8647 133.542 24.414V8.346C133.542 7.89533 133.689 7.52267 133.984 7.228C134.278 6.916 134.651 6.76 135.102 6.76C135.552 6.76 135.925 6.916 136.22 7.228C136.514 7.52267 136.662 7.89533 136.662 8.346V14.794L136.272 14.716C136.428 14.4213 136.644 14.1093 136.922 13.78C137.199 13.4333 137.537 13.1127 137.936 12.818C138.334 12.5233 138.776 12.2893 139.262 12.116C139.747 11.9253 140.276 11.83 140.848 11.83ZM156.212 11.83C157.495 11.83 158.465 12.0987 159.124 12.636C159.8 13.1733 160.259 13.8927 160.502 14.794C160.762 15.678 160.892 16.666 160.892 17.758V24.414C160.892 24.8647 160.745 25.246 160.45 25.558C160.155 25.8527 159.783 26 159.332 26C158.881 26 158.509 25.8527 158.214 25.558C157.919 25.246 157.772 24.8647 157.772 24.414V17.758C157.772 17.186 157.694 16.6747 157.538 16.224C157.399 15.756 157.139 15.3833 156.758 15.106C156.377 14.8287 155.831 14.69 155.12 14.69C154.427 14.69 153.837 14.8287 153.352 15.106C152.884 15.3833 152.52 15.756 152.26 16.224C152.017 16.6747 151.896 17.186 151.896 17.758V24.414C151.896 24.8647 151.749 25.246 151.454 25.558C151.159 25.8527 150.787 26 150.336 26C149.885 26 149.513 25.8527 149.218 25.558C148.923 25.246 148.776 24.8647 148.776 24.414V13.676C148.776 13.2253 148.923 12.8527 149.218 12.558C149.513 12.246 149.885 12.09 150.336 12.09C150.787 12.09 151.159 12.246 151.454 12.558C151.749 12.8527 151.896 13.2253 151.896 13.676V14.794L151.506 14.716C151.662 14.4213 151.887 14.1093 152.182 13.78C152.477 13.4333 152.823 13.1127 153.222 12.818C153.621 12.5233 154.071 12.2893 154.574 12.116C155.077 11.9253 155.623 11.83 156.212 11.83Z"
      fill="black"
    />
  </svg>
);

export function Navigation() {
  const pathname = usePathname();
  const [user, setUser] = useState<User | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const supabase = supabaseClient();
  const searchParams = useSearchParams();
  let hasCompanyData: boolean = true;
  if (searchParams.get("showToast") === "companySetupRequired")
    hasCompanyData = false;

  useEffect(() => {
    const fetchUser = async () => {
      setIsLoading(true);
      const {
        data: { user },
      } = await supabase.auth.getUser();
      setUser(user);
      setIsLoading(false);
    };

    fetchUser();

    const { data: authListener } = supabase.auth.onAuthStateChange(
      (event, session) => {
        console.log("Auth state changed:", event);
        setUser(session?.user ?? null);
        setIsLoading(false);
      },
    );

    return () => {
      authListener.subscription.unsubscribe();
    };
  }, [supabase]);

  const handleSignOut = async () => {
    setIsLoading(true);
    await logout();
    setUser(null);
    setIsLoading(false);
  };

  return (
    <header className="sticky flex flex-col top-0">
      {!hasCompanyData && (
        <div className="flex items-center justify-center bg-[#E57373] py-2">
          Por favor, ingresa tus datos de compañía
        </div>
      )}
      <div className="flex top-0 h-16 items-center gap-4 border-b bg-background px-4 md:px-6 z-50">
        <nav className="hidden flex-col gap-6 text-lg items-end font-medium md:flex md:flex-row md:gap-5 md:text-sm lg:gap-6 z-50">
          <Link
            href="#"
            className="flex items-center gap-2 text-lg font-semibold md:text-base"
          >
            <FacturaLogo />
          </Link>

          {navItems.map((item) => (
            <Link
              key={item.href}
              href={item.href}
              className={cn(
                "transition-colors hover:text-foreground",
                pathname === item.href
                  ? "text-foreground"
                  : "text-muted-foreground",
              )}
            >
              {item.label}
            </Link>
          ))}
        </nav>
        <Sheet>
          <SheetTrigger asChild>
            <Button
              variant="outline"
              size="icon"
              className="shrink-0 md:hidden"
            >
              <Menu className="h-5 w-5" />
              <span className="sr-only">Toggle navigation menu</span>
            </Button>
          </SheetTrigger>
          <SheetContent side="left">
            <nav className="grid gap-6 text-lg font-medium">
              <Link
                href="#"
                className="flex items-center gap-2 text-lg font-semibold"
              >
                <FacturaLogo />
              </Link>
              {navItems.map((item) => (
                <Link
                  key={item.href}
                  href={item.href}
                  className={cn(
                    "hover:text-foreground",
                    pathname === item.href
                      ? "text-foreground"
                      : "text-muted-foreground",
                  )}
                >
                  {item.label}
                </Link>
              ))}
            </nav>
          </SheetContent>
        </Sheet>
        <div className="profile-menu flex w-full items-center gap-4 md:ml-auto md:gap-2 lg:gap-4 justify-end">
          {isLoading ? (
            <p>Cargando...</p>
          ) : user ? (
            <>
              <p className="font-medium">
                Bienvenido, {user.user_metadata.full_name || user.email}
              </p>
              <DropdownMenu>
                <DropdownMenuTrigger asChild>
                  <Button
                    variant="secondary"
                    size="icon"
                    className="rounded-full"
                  >
                    {user.user_metadata.avatar_url ? (
                      <img
                        src={user.user_metadata.avatar_url}
                        alt="Profile"
                        className="h-8 w-8 rounded-full"
                      />
                    ) : (
                      <CircleUser className="h-5 w-5" />
                    )}
                    <span className="sr-only">Toggle user menu</span>
                  </Button>
                </DropdownMenuTrigger>
                <DropdownMenuContent align="end">
                  <DropdownMenuItem>
                    <Link href="/home/settings">Mi cuenta</Link>
                  </DropdownMenuItem>
                  <DropdownMenuSeparator />
                  <DropdownMenuItem onClick={handleSignOut}>
                    Cerrar Sesión
                  </DropdownMenuItem>
                </DropdownMenuContent>
              </DropdownMenu>
            </>
          ) : (
            <Link href="/auth/login" className="btn btn-ghost sign-in-btn">
              Iniciar Sesión
            </Link>
          )}
        </div>
      </div>
    </header>
  );
}
